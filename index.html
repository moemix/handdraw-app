<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Hand Draw – Air Sketch</title>
<style>
  body,html{margin:0;height:100%;background:#000;color:#fff;font-family:sans-serif}
  .stage{position:relative;width:100%;height:100%;overflow:hidden}
  video,canvas{position:absolute;inset:0}
  video{object-fit:cover}
  #paint{pointer-events:none}
  .hud{position:absolute;inset:0;pointer-events:none;color:#fff;padding:8px;font-size:14px;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>
<div class="stage" id="stage">
  <video id="video" playsinline muted></video>
  <canvas id="view"></canvas>
  <canvas id="paint"></canvas>
  <div class="hud">
    <div id="statMode">Mode: idle</div>
    <div id="statFps">FPS: –</div>
    <div id="debug"></div>
  </div>
</div>
<script>
const video = document.getElementById('video');
const view = document.getElementById('view');
const paint = document.getElementById('paint');
const statMode = document.getElementById('statMode');
const statFps = document.getElementById('statFps');
const debugEl = document.getElementById('debug');

let mirrored = true;
let lastPt = null;
let brushColor = '#7dd3fc';
let brushSize = 6;
let frames=0,lastTime=performance.now(),fps=0;

function resize(){
  const rect = view.getBoundingClientRect();
  [view, paint].forEach(c => {c.width = rect.width; c.height = rect.height});
}
window.addEventListener('resize', resize);
resize();

const hands = new Hands({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
hands.onResults(onResults);

const camera = new Camera(video, {
  onFrame: async () => {await hands.send({image: video});},
  width: 1280,
  height: 720
});
camera.start();

function lmToCanvas(lm){
  let x = lm.x * view.width;
  let y = lm.y * view.height;
  if(mirrored) x = view.width - x;
  return {x, y, z: lm.z};
}

function pinchDistance(lms){
  const tip = lmToCanvas(lms[8]);
  const th = lmToCanvas(lms[4]);
  return Math.hypot(tip.x - th.x, tip.y - th.y);
}

function onResults(results){
  const vctx = view.getContext('2d');
  const pctx = paint.getContext('2d');
  frames++; const now=performance.now(); if(now-lastTime>1000){fps=frames;frames=0;lastTime=now;statFps.textContent=`FPS: ${fps}`;}
  vctx.clearRect(0,0,view.width,view.height);
  vctx.save();
  if(mirrored) vctx.scale(-1,1), vctx.translate(-view.width,0);
  vctx.drawImage(video,0,0,view.width,view.height);
  vctx.restore();

  if(results.multiHandLandmarks && results.multiHandLandmarks.length){
    const lms = results.multiHandLandmarks[0];
    const pinch = pinchDistance(lms);
    const pinchActive = pinch < 40;
    statMode.textContent = pinchActive ? 'Mode: draw' : 'Mode: idle';

    // Draw lines between landmarks (hand skeleton)
    const connections = Hands.HAND_CONNECTIONS;
    vctx.strokeStyle = 'rgba(255,255,255,0.6)';
    vctx.lineWidth = 2;
    vctx.beginPath();
    for(const [start,end] of connections){
      const p1 = lmToCanvas(lms[start]);
      const p2 = lmToCanvas(lms[end]);
      vctx.moveTo(p1.x,p1.y);
      vctx.lineTo(p2.x,p2.y);
    }
    vctx.stroke();

    // Draw landmarks as dots
    vctx.fillStyle = '#fff';
    for(const lm of lms){
      const p = lmToCanvas(lm);
      vctx.beginPath();
      vctx.arc(p.x,p.y,4,0,Math.PI*2);
      vctx.fill();
    }

    if(pinchActive){
      const tip = lmToCanvas(lms[8]);
      if(lastPt){
        pctx.strokeStyle = brushColor;
        pctx.lineWidth = brushSize;
        pctx.lineCap = 'round';
        pctx.beginPath();
        pctx.moveTo(lastPt.x,lastPt.y);
        pctx.lineTo(tip.x,tip.y);
        pctx.stroke();
      }
      lastPt = tip;
    } else {
      lastPt = null;
    }

    debugEl.textContent = `pinch: ${pinch.toFixed(1)}`;
  } else {
    statMode.textContent = 'Mode: no-hand';
    lastPt = null;
  }
}
</script>
</body>
</html>
